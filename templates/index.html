<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>FritzBox Thermostat Controller</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:20px}</style>
</head>
<body>
  <h1>FritzBox Thermostat Controller</h1>
  <p>Real FritzBox integration: {{ 'ja' if real else 'nein (Mock aktiv)' }}</p>
  <ul>
  {% for d in devices %}
    <li>
      <a href="#" onclick="openDevice('{{ d.ain }}');return false">{{ d.name }} ({{ d.ain }})</a>
    </li>
  {% endfor %}
  </ul>

  <div id="device" style="margin-top:20px"></div>

  <script>
  async function openDevice(ain){
    const res = await fetch('/api/device/'+ain+'/history')
    const data = await res.json()
    document.getElementById('device').innerHTML = `<h2>Device ${ain}</h2><canvas id="chart"></canvas><div><label>Set temp <input id='t' type='number' step='0.5'/> <button onclick="setTemp('${ain}')">Set</button></label></div>`
    const labels = data.map(r=>new Date(r.created_at).toLocaleString()).reverse()
    const temps = data.map(r=>r.measured_temp).reverse()
    const ctx = document.getElementById('chart').getContext('2d')
    new Chart(ctx,{type:'line',data:{labels:labels,datasets:[{label:'Measured temp',data:temps,borderColor:'rgb(75,192,192)',tension:0.2}]}})
  }

  async function setTemp(ain){
    const t = parseFloat(document.getElementById('t').value)
    await fetch('/api/device/'+ain+'/set_temp',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({temp:t})})
    alert('ok')
  }
  </script>
</body>
</html>